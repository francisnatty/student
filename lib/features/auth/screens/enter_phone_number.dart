// enter_phone_number.dart

import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:provider/provider.dart'; // Ensure Provider is imported
import 'package:student_centric_app/core/utils/app_colors.dart';
import 'package:student_centric_app/features/auth/providers/auth_provider.dart'; // Import AuthProvider
import 'package:student_centric_app/features/auth/widgets/auth_appbar.dart';
import 'package:student_centric_app/widgets/app_button.dart';
import 'package:student_centric_app/widgets/app_textfield.dart';

class EnterPhoneNumberScreen extends StatefulWidget {
  const EnterPhoneNumberScreen({super.key});

  @override
  _EnterPhoneNumberScreenState createState() => _EnterPhoneNumberScreenState();
}

class _EnterPhoneNumberScreenState extends State<EnterPhoneNumberScreen> {
  String selectedCountryCode = "+1"; // Default country code
  String selectedFlag = "ğŸ‡ºğŸ‡¸"; // Default flag
  final TextEditingController _phoneController = TextEditingController();
// Expanded list of countries with names, including more African countries
  final List<Map<String, String>> countryCodes = [
    // North America
    {"code": "+1", "flag": "ğŸ‡ºğŸ‡¸", "name": "United States"},
    {"code": "+1", "flag": "ğŸ‡¨ğŸ‡¦", "name": "Canada"},
    {"code": "+1", "flag": "ğŸ‡¯ğŸ‡²", "name": "Jamaica"},
    // Europe
    {"code": "+44", "flag": "ğŸ‡¬ğŸ‡§", "name": "United Kingdom"},
    {"code": "+49", "flag": "ğŸ‡©ğŸ‡ª", "name": "Germany"},
    {"code": "+33", "flag": "ğŸ‡«ğŸ‡·", "name": "France"},
    {"code": "+39", "flag": "ğŸ‡®ğŸ‡¹", "name": "Italy"},
    {"code": "+7", "flag": "ğŸ‡·ğŸ‡º", "name": "Russia"},
    // Asia
    {"code": "+91", "flag": "ğŸ‡®ğŸ‡³", "name": "India"},
    {"code": "+81", "flag": "ğŸ‡¯ğŸ‡µ", "name": "Japan"},
    {"code": "+86", "flag": "ğŸ‡¨ğŸ‡³", "name": "China"},
    // Oceania
    {"code": "+61", "flag": "ğŸ‡¦ğŸ‡º", "name": "Australia"},
    {"code": "+64", "flag": "ğŸ‡³ğŸ‡¿", "name": "New Zealand"},
    // Africa
    {"code": "+213", "flag": "ğŸ‡©ğŸ‡¿", "name": "Algeria"},
    {"code": "+216", "flag": "ğŸ‡¹ğŸ‡³", "name": "Tunisia"},
    {"code": "+218", "flag": "ğŸ‡±ğŸ‡¾", "name": "Libya"},
    {"code": "+220", "flag": "ğŸ‡¬ğŸ‡²", "name": "Gambia"},
    {"code": "+221", "flag": "ğŸ‡¸ğŸ‡³", "name": "Senegal"},
    {"code": "+222", "flag": "ğŸ‡¸ğŸ‡³", "name": "Mauritania"},
    {"code": "+223", "flag": "ğŸ‡²ğŸ‡±", "name": "Mali"},
    {"code": "+224", "flag": "ğŸ‡¸ğŸ‡±", "name": "Sierra Leone"},
    {"code": "+225", "flag": "ğŸ‡¨ğŸ‡®", "name": "CÃ´te d'Ivoire"},
    {"code": "+226", "flag": "ğŸ‡§ğŸ‡«", "name": "Burkina Faso"},
    {"code": "+227", "flag": "ğŸ‡³ğŸ‡ª", "name": "Niger"},
    {"code": "+228", "flag": "ğŸ‡¹ğŸ‡¬", "name": "Togo"},
    {"code": "+229", "flag": "ğŸ‡§ğŸ‡¯", "name": "Benin"},
    {"code": "+230", "flag": "ğŸ‡²ğŸ‡º", "name": "Mauritius"},
    {"code": "+231", "flag": "ğŸ‡±ğŸ‡·", "name": "Liberia"},
    {"code": "+232", "flag": "ğŸ‡¸ğŸ‡±", "name": "Sierra Leone"},
    {"code": "+233", "flag": "ğŸ‡¬ğŸ‡­", "name": "Ghana"},
    {"code": "+234", "flag": "ğŸ‡³ğŸ‡¬", "name": "Nigeria"},
    {"code": "+235", "flag": "ğŸ‡¨ğŸ‡²", "name": "Chad"},
    {"code": "+236", "flag": "ğŸ‡¨ğŸ‡«", "name": "Central African Republic"},
    {"code": "+237", "flag": "ğŸ‡¨ğŸ‡²", "name": "Cameroon"},
    {"code": "+238", "flag": "ğŸ‡¨ğŸ‡»", "name": "Cape Verde"},
    {"code": "+239", "flag": "ğŸ‡¸ğŸ‡¹", "name": "SÃ£o TomÃ© and Principe"},
    {"code": "+240", "flag": "ğŸ‡¬ğŸ‡¶", "name": "Equatorial Guinea"},
    {"code": "+241", "flag": "ğŸ‡¬ğŸ‡¦", "name": "Gabon"},
    {"code": "+242", "flag": "ğŸ‡¨ğŸ‡¬", "name": "Republic of the Congo"},
    {
      "code": "+243",
      "flag": "ğŸ‡¨ğŸ‡©",
      "name": "Democratic Republic of the Congo"
    },
    {"code": "+244", "flag": "ğŸ‡¦ğŸ‡´", "name": "Angola"},
    {"code": "+245", "flag": "ğŸ‡¬ğŸ‡¼", "name": "Guinea-Bissau"},
    {"code": "+246", "flag": "ğŸ‡¹ğŸ‡°", "name": "Tristan da Cunha"},
    {"code": "+247", "flag": "ğŸ‡¸ğŸ‡­", "name": "Ascension Island"},
    {"code": "+248", "flag": "ğŸ‡¸ğŸ‡¨", "name": "Seychelles"},
    {"code": "+249", "flag": "ğŸ‡¸ğŸ‡©", "name": "Sudan"},
    {"code": "+250", "flag": "ğŸ‡·ğŸ‡¼", "name": "Rwanda"},
    {"code": "+251", "flag": "ğŸ‡ªğŸ‡¹", "name": "Ethiopia"},
    {"code": "+252", "flag": "ğŸ‡¸ğŸ‡´", "name": "Somalia"},
    {"code": "+253", "flag": "ğŸ‡©ğŸ‡¯", "name": "Djibouti"},
    {"code": "+254", "flag": "ğŸ‡°ğŸ‡ª", "name": "Kenya"},
    {"code": "+255", "flag": "ğŸ‡¹ğŸ‡¿", "name": "Tanzania"},
    {"code": "+256", "flag": "ğŸ‡ºğŸ‡¬", "name": "Uganda"},
    {"code": "+257", "flag": "ğŸ‡§ğŸ‡¯", "name": "Burundi"},
    {"code": "+258", "flag": "ğŸ‡²ğŸ‡¿", "name": "Mozambique"},
    {"code": "+260", "flag": "ğŸ‡¿ğŸ‡²", "name": "Zambia"},
    {"code": "+261", "flag": "ğŸ‡²ğŸ‡¬", "name": "Madagascar"},
    {"code": "+262", "flag": "ğŸ‡¾ğŸ‡¹", "name": "Mayotte"},
    {"code": "+263", "flag": "ğŸ‡¿ğŸ‡¼", "name": "Zimbabwe"},
    {"code": "+264", "flag": "ğŸ‡³ğŸ‡¦", "name": "Namibia"},
    {"code": "+265", "flag": "ğŸ‡²ğŸ‡¼", "name": "Malawi"},
    {"code": "+266", "flag": "ğŸ‡±ğŸ‡¸", "name": "Lesotho"},
    {"code": "+267", "flag": "ğŸ‡§ğŸ‡¼", "name": "Botswana"},
    {"code": "+268", "flag": "ğŸ‡²ğŸ‡º", "name": "Eswatini"},
    {"code": "+269", "flag": "ğŸ‡°ğŸ‡²", "name": "Comoros"},
    {"code": "+27", "flag": "ğŸ‡¿ğŸ‡¦", "name": "South Africa"},
    {"code": "+290", "flag": "ğŸ‡¸ğŸ‡­", "name": "Saint Helena"},
    {"code": "+291", "flag": "ğŸ‡ªğŸ‡·", "name": "Eritrea"},
    {"code": "+297", "flag": "ğŸ‡¦ğŸ‡¼", "name": "Aruba"},
    {"code": "+298", "flag": "ğŸ‡«ğŸ‡´", "name": "Faroe Islands"},
    {"code": "+299", "flag": "ğŸ‡¬ğŸ‡±", "name": "Greenland"},
  ];

  void _showCountryPicker() {
    showModalBottomSheet(
      backgroundColor: Colors.white,
      context: context,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(16.r)),
      ),
      builder: (context) {
        TextEditingController searchController = TextEditingController();
        List<Map<String, String>> filteredCountryCodes =
            List.from(countryCodes);

        return StatefulBuilder(
          builder: (BuildContext context, StateSetter setModalState) {
            return Container(
              height: 700.h, // Adjust the height as needed
              padding: EdgeInsets.symmetric(horizontal: 16.w, vertical: 16.h),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Header with Title and Close Button
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        "Select Your Country",
                        style: TextStyle(
                          fontSize: 18.sp,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      GestureDetector(
                        onTap: () {
                          Navigator.pop(context);
                        },
                        child: CircleAvatar(
                          radius: 16.r,
                          backgroundColor: AppColors.greyAlt,
                          child: Icon(
                            Icons.close,
                            size: 18.sp,
                            color: AppColors.primaryColor,
                          ),
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: 16.h),
                  // Search TextField
                  TextField(
                    controller: searchController,
                    onChanged: (value) {
                      setModalState(() {
                        filteredCountryCodes = countryCodes.where((country) {
                          final countryName = country['name']!.toLowerCase();
                          return countryName.contains(value.toLowerCase());
                        }).toList();
                      });
                    },
                    decoration: InputDecoration(
                      hintText: 'Search country',
                      prefixIcon: const Icon(Icons.search),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8.r),
                      ),
                    ),
                  ),
                  SizedBox(height: 16.h),
                  Divider(
                    thickness: 1,
                    color: Colors.grey[300],
                  ),
                  SizedBox(height: 16.h),
                  // List of Countries
                  Expanded(
                    child: ListView.builder(
                      itemCount: filteredCountryCodes.length,
                      itemBuilder: (context, index) {
                        final country = filteredCountryCodes[index];
                        return ListTile(
                          leading: Text(
                            country["flag"] ?? "",
                            style: TextStyle(fontSize: 24.sp),
                          ),
                          title: Text(
                            country["name"] ?? "",
                            style: TextStyle(fontSize: 16.sp),
                          ),
                          subtitle: Text(
                            country["code"] ?? "",
                            style:
                                TextStyle(fontSize: 14.sp, color: Colors.grey),
                          ),
                          onTap: () {
                            setState(() {
                              selectedCountryCode = country["code"]!;
                              selectedFlag = country["flag"]!;
                            });
                            Navigator.pop(context);
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            );
          },
        );
      },
    );
  }

  @override
  void dispose() {
    _phoneController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final authProvider =
        Provider.of<AuthProvider>(context); // Access AuthProvider

    return Scaffold(
      appBar: const AuthAppbar(),
      body: Padding(
        padding:
            EdgeInsets.symmetric(horizontal: 16.w), // Adjust padding as needed
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            20.verticalSpace,
            Text(
              "Enter\nPhone Number",
              style: TextStyle(
                fontSize: 32.sp,
                fontWeight: FontWeight.w900,
              ),
            ),
            50.verticalSpace,
            Row(
              children: [
                // Country picker as a read-only text field
                SizedBox(
                  width: 140.w, // Adjust width as needed
                  child: AppTextfield.regular(
                    controller: TextEditingController(
                        text: "$selectedFlag $selectedCountryCode"),
                    readOnly: true,
                    onTap: _showCountryPicker,
                    // Optionally, add an icon to indicate it's a dropdown
                    suffixIcon:
                        const Icon(Icons.arrow_drop_down, color: Colors.black),
                    hintText: '',
                    // Customize the appearance to match your text fields
                  ),
                ),
                SizedBox(width: 10.w),
                // Phone number text field
                Expanded(
                  flex: 5, // Adjust flex as needed
                  child: AppTextfield.regular(
                    controller: _phoneController,
                    hintText: "Enter Phone Number",
                    keyboardType: TextInputType.phone,
                  ),
                ),
              ],
            ),
            10.verticalSpace,
            TextButton(
              onPressed: () {
                // Optionally, handle what happens if the number changes
              },
              child: Text(
                "What if my number changes?",
                style: TextStyle(
                  fontSize: 12.sp,
                  color: AppColors.primaryColor,
                ),
              ),
            ),
            const Spacer(), // Spacer pushes the next widget to the bottom
            authProvider.isLoading
                ? const Center(child: CircularProgressIndicator())
                : AppButton.primary(
                    text: "Proceed",
                    onPressed: () async {
                      final email = authProvider.email;
                      final phoneNumber =
                          "$selectedCountryCode${_phoneController.text.trim()}";

                      if (email == null || email.isEmpty) {
                        // Handle missing email
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                            content:
                                Text("Email is missing. Please sign up again."),
                          ),
                        );
                        return;
                      }

                      if (_phoneController.text.trim().isEmpty) {
                        // Handle empty phone number
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                            content: Text("Please enter a valid phone number."),
                          ),
                        );
                        return;
                      }

                      // Call the provider method to add phone number
                      await authProvider.addPhoneNumber(
                        email: email,
                        phoneNumber: phoneNumber,
                        context: context,
                      );
                    },
                  ),
            20.verticalSpace, // Add some space below the button for better spacing
          ],
        ),
      ),
    );
  }
}
